<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcPro - Calculadora de C√°lculo Num√©rico</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/mathjs@12.4.1/lib/browser/math.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        }
    </script>

    <style>
        @import url('https://rsms.me/inter/inter.css');
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .dark .glass-effect {
            background-color: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .function-input { font-family: 'Fira Code', 'Courier New', monospace; }
        .keypad-btn { transition: all 0.15s ease-in-out; }
        .keypad-btn:active { transform: scale(0.95); }
        .step-card {
            background-color: rgba(255, 255, 255, 0.5);
            border-left: 4px solid #3b82f6; /* Azul-500 */
        }
        .dark .step-card {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .katex { font-size: 1.1em !important; }
    </style>
</head>

<body class="bg-slate-50 dark:bg-gray-900 text-slate-800 dark:text-slate-200 min-h-screen transition-colors duration-300 p-4 md:p-6">
    
    <main class="max-w-7xl mx-auto">
        <nav class="glass-effect rounded-2xl p-4 shadow-lg sticky top-4 z-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-white font-bold text-lg">‚à´</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">CalcPro</h1>
                        <p class="text-xs text-slate-600 dark:text-slate-400">C√°lculo Num√©rico Avan√ßado</p>
                    </div>
                </div>
                
                <div id="nav-operations" class="hidden md:flex items-center space-x-6 text-sm font-medium text-slate-600 dark:text-slate-300">
                    <button data-operation="derivative" class="nav-btn transition-colors hover:text-blue-500">üìà Derivadas</button>
                    <button data-operation="critical" class="nav-btn transition-colors hover:text-green-500">üéØ Pontos Cr√≠ticos</button>
                    <button data-operation="integral" class="nav-btn transition-colors hover:text-purple-500">‚à´ Integrais</button>
                
                </div>

                <div class="flex items-center space-x-3">
                    <button id="theme-toggle-btn" class="p-2 rounded-lg bg-white/20 dark:bg-black/20 hover:bg-white/30 dark:hover:bg-black/30 transition-all duration-300">
                        <span id="themeIcon" class="text-lg">üåô</span>
                    </button>
                </div>
            </div>
        </nav>

        <div class="mt-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1">
                <div class="glass-effect rounded-2xl p-6 shadow-lg sticky top-24">
                    <h3 class="text-lg font-bold mb-4">Teoria R√°pida</h3>
                    <div id="theoryContent" class="space-y-4 text-sm">
                        <div class="bg-white/50 dark:bg-black/20 rounded-lg p-3">
                            <h4 class="font-semibold mb-2">üí° Bem-vindo!</h4>
                            <p class="text-slate-600 dark:text-slate-300">Selecione uma opera√ß√£o no menu superior para come√ßar.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div id="inputSection" class="glass-effect rounded-2xl p-6 shadow-lg mb-6 animate-fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold flex items-center">
                            <span id="operationIcon" class="mr-3 text-2xl">üßÆ</span>
                            <span id="operationTitle">Calculadora</span>
                        </h3>
                        <div class="flex space-x-2">
                            <button id="clear-btn" class="px-3 py-1 text-sm bg-slate-200 dark:bg-slate-700 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Limpar</button>
                            <button id="example-btn" class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800/50 transition-colors">Exemplo</button>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white/50 dark:bg-black/20 rounded-xl p-4">
                            <label for="functionInput" class="block text-sm font-semibold mb-3">üìù Fun√ß√£o f(x)</label>
                            <div class="relative">
                                <input type="text" id="functionInput" placeholder="Selecione uma opera√ß√£o..." class="function-input w-full p-4 border-2 border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800 text-lg transition-all" disabled>
                                <div id="functionStatus" class="absolute right-4 top-1/2 -translate-y-1/2"></div>
                            </div>
                            <div id="keypad" class="mt-4 grid grid-cols-5 gap-2 text-slate-800 dark:text-slate-200 font-semibold">
                                <button data-value="sin(" class="keypad-btn p-3 bg-blue-100 dark:bg-blue-900/50 rounded-lg">sin</button>
                                <button data-value="cos(" class="keypad-btn p-3 bg-blue-100 dark:bg-blue-900/50 rounded-lg">cos</button>
                                <button data-value="log(" class="keypad-btn p-3 bg-blue-100 dark:bg-blue-900/50 rounded-lg">ln</button>
                                <button data-value="(" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">(</button>
                                <button data-value=")" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">)</button>
                                <button data-value="7" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">7</button>
                                <button data-value="8" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">8</button>
                                <button data-value="9" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">9</button>
                                <button data-value="/" class="keypad-btn p-3 bg-purple-100 dark:bg-purple-900/50 rounded-lg text-purple-700 dark:text-purple-300">√∑</button>
                                <button data-action="backspace" class="keypad-btn p-3 bg-red-100 dark:bg-red-900/50 rounded-lg text-red-600 dark:text-red-300 text-xl">‚å´</button>
                                <button data-value="4" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">4</button>
                                <button data-value="5" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">5</button>
                                <button data-value="6" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">6</button>
                                <button data-value="*" class="keypad-btn p-3 bg-purple-100 dark:bg-purple-900/50 rounded-lg text-purple-700 dark:text-purple-300">√ó</button>
                                <button data-value="^" class="keypad-btn p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg text-yellow-700 dark:text-yellow-300">^</button>
                                <button data-value="1" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">1</button>
                                <button data-value="2" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">2</button>
                                <button data-value="3" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">3</button>
                                <button data-value="-" class="keypad-btn p-3 bg-green-100 dark:bg-green-900/50 rounded-lg text-green-700 dark:text-green-300">-</button>
                                <button data-value="+" class="keypad-btn p-3 bg-green-100 dark:bg-green-900/50 rounded-lg row-span-2 text-2xl text-green-700 dark:text-green-300">+</button>
                                <button data-value="0" class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg col-span-2">0</button>
                                <button data-value="." class="keypad-btn p-3 bg-slate-200 dark:bg-slate-700 rounded-lg">.</button>
                                <button data-value="x" class="keypad-btn p-3 bg-pink-100 dark:bg-pink-900/50 rounded-lg text-pink-700 dark:text-pink-300">x</button>
                            </div>
                        </div>

                        <div id="derivativePointInput" class="hidden bg-white/50 dark:bg-black/20 rounded-xl p-4">
                            <label for="derivativePoint" class="block text-sm font-semibold mb-3">üìç Ponto de An√°lise (x)</label>
                            <input type="number" id="derivativePoint" value="0" step="0.1" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700">
                        </div>
                        <div id="intervalInputs" class="hidden bg-white/50 dark:bg-black/20 rounded-xl p-4">
                            <label class="block text-sm font-semibold mb-3">üìè Intervalo de An√°lise</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="lowerLimit" class="block text-xs mb-1">Limite inferior (a)</label>
                                    <input type="number" id="lowerLimit" value="-5" step="0.1" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700">
                                </div>
                                <div>
                                    <label for="upperLimit" class="block text-xs mb-1">Limite superior (b)</label>
                                    <input type="number" id="upperLimit" value="5" step="0.1" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700">
                                </div>
                            </div>
                        </div>

                        <button id="calculateBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 rounded-xl shadow-lg transition-transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100">
                            Calcular
                        </button>
                    </div>
                </div>

                <div id="resultsSection" class="hidden animate-fade-in">
                    <div class="space-y-6">
                        <div class="glass-effect rounded-2xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-3 text-2xl">üìä</span>Resumo do Resultado</h3>
                            <div id="summaryResults"></div>
                        </div>

                        <div class="glass-effect rounded-2xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-3 text-2xl">üìù</span>Passo a Passo da Resolu√ß√£o</h3>
                            <div id="stepByStepResults" class="space-y-4"></div>
                        </div>
                        
                        <div class="glass-effect rounded-2xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-3 text-2xl">üìà</span>Visualiza√ß√£o Gr√°fica</h3>
                            <div id="plotDiv" class="rounded-xl overflow-hidden h-[500px]"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CalcProApp = {
            state: {
                currentOperation: null,
                isDarkMode: false,
            },
            ui: {},
            config: {
                operations: {
                    derivative: { title: 'C√°lculo de Derivadas', icon: 'üìà', example: 'x^3 - 2*x^2 + 5' },
                    critical: { title: 'An√°lise de Pontos Cr√≠ticos', icon: 'üéØ', example: 'x^3 - 3*x' },
                    integral: { title: 'Integra√ß√£o Num√©rica', icon: '‚à´', example: 'sin(x)+1' },
                },
                plotLayout: {
                    showlegend: true,
                    hovermode: 'x unified',
                    margin: { t: 50, r: 20, b: 50, l: 50 },
                }
            },

            // --- M√âTODOS DE INICIALIZA√á√ÉO E GERENCIAMENTO DE UI ---
            init() {
                this.cacheDOM();
                this.bindEventListeners();
                this.loadInitialState();
                this.updateUIForOperation();
            },

            cacheDOM() {
                this.ui = {
                    themeToggleBtn: document.getElementById('theme-toggle-btn'),
                    themeIcon: document.getElementById('themeIcon'),
                    navOperations: document.getElementById('nav-operations'),
                    functionInput: document.getElementById('functionInput'),
                    functionStatus: document.getElementById('functionStatus'),
                    keypad: document.getElementById('keypad'),
                    operationTitle: document.getElementById('operationTitle'),
                    operationIcon: document.getElementById('operationIcon'),
                    derivativePointInput: document.getElementById('derivativePointInput'),
                    intervalInputs: document.getElementById('intervalInputs'),
                    clearBtn: document.getElementById('clear-btn'),
                    exampleBtn: document.getElementById('example-btn'),
                    calculateBtn: document.getElementById('calculateBtn'),
                    resultsSection: document.getElementById('resultsSection'),
                    summaryResults: document.getElementById('summaryResults'),
                    stepByStepResults: document.getElementById('stepByStepResults'),
                    plotDiv: document.getElementById('plotDiv'),
                    theoryContent: document.getElementById('theoryContent'),
                    theoryBtn: document.getElementById('theory-btn'),
                };
            },

            bindEventListeners() {
                this.ui.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                this.ui.navOperations.addEventListener('click', (e) => {
                    if (e.target.dataset.operation) this.selectOperation(e.target.dataset.operation);
                });
                this.ui.functionInput.addEventListener('input', () => this.validateFunction());
                this.ui.keypad.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const { value, action } = target.dataset;
                    if (value) this.insertIntoInput(value);
                    if (action === 'backspace') this.handleBackspace();
                });
                this.ui.clearBtn.addEventListener('click', () => this.clearAll());
                this.ui.exampleBtn.addEventListener('click', () => this.loadExample());
                this.ui.calculateBtn.addEventListener('click', () => this.handleCalculation());
                this.ui.theoryBtn.addEventListener('click', () => this.showTheory());
            },

            loadInitialState() {
                const savedTheme = localStorage.getItem('theme');
                this.state.isDarkMode = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
                this.updateTheme();
            },

            selectOperation(opName) {
                this.state.currentOperation = opName;
                this.updateUIForOperation();
                this.ui.functionInput.focus();
            },

            updateUIForOperation() {
                const op = this.config.operations[this.state.currentOperation];
                
                this.ui.navOperations.querySelectorAll('.nav-btn').forEach(btn => {
                    const isSelected = btn.dataset.operation === this.state.currentOperation;
                    btn.classList.toggle('font-bold', isSelected);
                    btn.classList.toggle('text-blue-500', isSelected);
                    btn.classList.toggle('dark:text-blue-400', isSelected);
                });

                if (op) {
                    this.ui.operationTitle.textContent = op.title;
                    this.ui.operationIcon.textContent = op.icon;
                    this.ui.functionInput.placeholder = `Ex: ${op.example}`;
                    this.ui.functionInput.disabled = false;
                } else {
                    this.ui.operationTitle.textContent = 'Calculadora';
                    this.ui.operationIcon.textContent = 'üßÆ';
                    this.ui.functionInput.placeholder = 'Selecione uma opera√ß√£o...';
                    this.ui.functionInput.disabled = true;
                }
                
                this.ui.derivativePointInput.classList.toggle('hidden', this.state.currentOperation !== 'derivative');
                this.ui.intervalInputs.classList.toggle('hidden', !['critical', 'integral'].includes(this.state.currentOperation));
                
                this.clearAll();
                this.showTheory();
            },

            toggleTheme() {
                this.state.isDarkMode = !this.state.isDarkMode;
                this.updateTheme();
            },

            updateTheme() {
                document.documentElement.classList.toggle('dark', this.state.isDarkMode);
                this.ui.themeIcon.textContent = this.state.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem('theme', this.state.isDarkMode ? 'dark' : 'light');
                this.updatePlotTheme();
            },

            // --- M√âTODOS DE MANIPULA√á√ÉO DO INPUT ---

            insertIntoInput(value) {
                const { functionInput } = this.ui;
                const { selectionStart, selectionEnd } = functionInput;
                functionInput.value = functionInput.value.substring(0, selectionStart) + value + functionInput.value.substring(selectionEnd);
                const newPos = selectionStart + value.length;
                functionInput.focus();
                functionInput.setSelectionRange(newPos, newPos);
                this.validateFunction();
            },

            handleBackspace() {
                const { functionInput } = this.ui;
                const { selectionStart, selectionEnd } = functionInput;
                if (selectionStart > 0 && selectionStart === selectionEnd) {
                    const newPos = selectionStart - 1;
                    functionInput.value = functionInput.value.substring(0, newPos) + functionInput.value.substring(selectionEnd);
                    functionInput.focus();
                    functionInput.setSelectionRange(newPos, newPos);
                }
                this.validateFunction();
            },
            
            validateFunction() {
                const funcStr = this.ui.functionInput.value.trim();
                if (!funcStr) {
                    this.ui.functionStatus.innerHTML = '';
                    this.ui.functionInput.classList.remove('border-red-500', 'border-green-500');
                    return false;
                }
                try {
                    math.parse(this.helpers.parseFunction(funcStr)).evaluate({x: 1});
                    this.ui.functionStatus.innerHTML = '<span class="text-green-500 text-xl">‚úì</span>';
                    this.ui.functionInput.classList.remove('border-red-500'); this.ui.functionInput.classList.add('border-green-500');
                    return true;
                } catch (e) {
                    this.ui.functionStatus.innerHTML = '<span class="text-red-500 text-xl">‚úó</span>';
                    this.ui.functionInput.classList.remove('border-green-500'); this.ui.functionInput.classList.add('border-red-500');
                    return false;
                }
            },
            
            clearAll() {
                this.ui.functionInput.value = '';
                this.validateFunction();
                this.ui.resultsSection.classList.add('hidden');
                document.getElementById('derivativePoint').value = 0;
                document.getElementById('lowerLimit').value = -5;
                document.getElementById('upperLimit').value = 5;
            },

            loadExample() {
                if(this.state.currentOperation) {
                    this.ui.functionInput.value = this.config.operations[this.state.currentOperation].example;
                    this.validateFunction();
                }
            },

            showTheory() {
                let html = '';
                switch (this.state.currentOperation) {
                    case 'derivative':
                        html = `
                            <h4 class="font-semibold mb-2">üìà Derivadas</h4>
                            <div class="space-y-2">
                                <p>
                                    <strong>Conceito:</strong><br>
                                    A derivada de uma fun√ß√£o $f(x)$ representa a taxa de varia√ß√£o instant√¢nea de $f$ em rela√ß√£o a $x$. √â como medir a inclina√ß√£o da curva em cada ponto. No gr√°fico, a derivada indica se a fun√ß√£o est√° subindo, descendo ou estacion√°ria.
                                </p>
                                <p>
                                    <strong>Aplica√ß√µes:</strong><br>
                                    - Encontrar m√°ximos e m√≠nimos locais (otimiza√ß√£o)<br>
                                    - Estudar o comportamento de gr√°ficos (crescimento/decrescimento)<br>
                                    - Calcular velocidade, acelera√ß√£o, taxas de crescimento, juros instant√¢neos, etc.<br>
                                    - Modelagem de fen√¥menos f√≠sicos e econ√¥micos
                                </p>
                                <p>
                                    <strong>Como calcular?</strong><br>
                                    A derivada pode ser obtida por regras alg√©bricas (manual) ou por m√©todos num√©ricos (aproxima√ß√£o).<br>
                                    <em>Exemplo:</em> Se $f(x) = x^2$, ent√£o $f'(x) = 2x$.<br>
                                    <em>Regras comuns:</em><br>
                                    $$ \\frac{d}{dx}[x^n] = n x^{n-1} $$<br>
                                    $$ \\frac{d}{dx}[f(x)+g(x)] = f'(x)+g'(x) $$<br>
                                    $$ \\frac{d}{dx}[f(x)g(x)] = f'(x)g(x) + f(x)g'(x) $$<br>
                                    $$ \\frac{d}{dx}[f(g(x))] = f'(g(x))g'(x) $$
                                </p>
                                <p>
                                    <strong>Dicas:</strong><br>
                                    - Fun√ß√µes polinomiais t√™m derivadas simples.<br>
                                    - Para fun√ß√µes trigonom√©tricas: $\\frac{d}{dx}[\\sin(x)] = \\cos(x)$, $\\frac{d}{dx}[\\cos(x)] = -\\sin(x)$.<br>
                                    - A derivada de uma constante √© zero.<br>
                                    - A derivada pode ser usada para encontrar pontos de m√°ximo, m√≠nimo e inflex√£o.
                                </p>
                                <p>
                                    <strong>Exemplo pr√°tico:</strong><br>
                                    Se $f(x) = 3x^3 - 2x^2 + 5$, ent√£o $f'(x) = 9x^2 - 4x$.<br>
                                    Para $x = 1$: $f'(1) = 9 \cdot 1^2 - 4 \cdot 1 = 5$.
                                </p>
                                <p>
                                    <strong>Curiosidade:</strong><br>
                                    A derivada √© a base do c√°lculo diferencial e aparece em quase todas as √°reas da ci√™ncia e engenharia.
                                </p>
                            </div>
                        `;
                        break;
                    case 'critical':
                        html = `
                            <h4 class="font-semibold mb-2">üéØ Pontos Cr√≠ticos</h4>
                            <div class="space-y-2">
                                <p>
                                    <strong>Conceito:</strong><br>
                                    Pontos cr√≠ticos s√£o valores de $x$ onde a derivada da fun√ß√£o √© zero ou n√£o existe. Eles indicam poss√≠veis m√°ximos, m√≠nimos ou pontos de inflex√£o no gr√°fico da fun√ß√£o.
                                </p>
                                <p>
                                    <strong>Aplica√ß√µes:</strong><br>
                                    - Identificar extremos locais (m√°ximos/m√≠nimos)<br>
                                    - Analisar estabilidade de sistemas f√≠sicos e econ√¥micos<br>
                                    - Estudar mudan√ßas de concavidade (pontos de inflex√£o)<br>
                                    - Otimiza√ß√£o de processos e recursos
                                </p>
                                <p>
                                    <strong>Como encontrar?</strong><br>
                                    1. Calcule $f'(x)$ e encontre os pontos onde $f'(x) = 0$ ou $f'(x)$ n√£o existe.<br>
                                    2. Use $f''(x)$ para classificar:<br>
                                    &nbsp;&nbsp;- Se $f''(x) > 0$: m√≠nimo local (curva para cima)<br>
                                    &nbsp;&nbsp;- Se $f''(x) < 0$: m√°ximo local (curva para baixo)<br>
                                    &nbsp;&nbsp;- Se $f''(x) = 0$: ponto de inflex√£o ou teste adicional
                                </p>
                                <p>
                                    <strong>Dicas:</strong><br>
                                    - Sempre analise o intervalo de interesse.<br>
                                    - Fun√ß√µes polinomiais podem ter v√°rios pontos cr√≠ticos.<br>
                                    - Pontos de inflex√£o mudam a concavidade do gr√°fico.<br>
                                    - Nem todo ponto onde $f'(x)=0$ √© m√°ximo ou m√≠nimo; pode ser inflex√£o.
                                </p>
                                <p>
                                    <strong>Exemplo pr√°tico:</strong><br>
                                    Para $f(x) = x^3 - 3x$, $f'(x) = 3x^2 - 3$.<br>
                                    Pontos cr√≠ticos: $x = -1$ e $x = 1$.<br>
                                    Classifica√ß√£o pelo sinal de $f''(x)$:<br>
                                    $f''(x) = 6x \rightarrow f''(-1) = -6$ (m√°ximo), $f''(1) = 6$ (m√≠nimo).
                                </p>
                                <p>
                                    <strong>Curiosidade:</strong><br>
                                    Pontos cr√≠ticos s√£o essenciais em problemas de otimiza√ß√£o, como maximizar lucro ou minimizar custos.
                                </p>
                            </div>
                        `;
                        break;
                    case 'integral':
                        html = `
                            <h4 class="font-semibold mb-2">‚à´ Integrais</h4>
                            <div class="space-y-2">
                                <p>
                                    <strong>Conceito:</strong><br>
                                    A integral definida calcula a √°rea sob a curva de uma fun√ß√£o entre dois pontos. √â usada para somar valores cont√≠nuos, como √°rea, volume, dist√¢ncia, trabalho, energia, etc.
                                </p>
                                <p>
                                    <strong>Aplica√ß√µes:</strong><br>
                                    - Calcular √°reas e volumes<br>
                                    - Determinar dist√¢ncia percorrida a partir da velocidade<br>
                                    - Somar grandezas f√≠sicas ao longo de um intervalo<br>
                                    - C√°lculo de trabalho, energia, probabilidade acumulada
                                </p>
                                <p>
                                    <strong>Como calcular?</strong><br>
                                    A integral definida de $f(x)$ de $a$ at√© $b$ √©:<br>
                                    $$ \\int_a^b f(x) \\, dx $$<br>
                                    Pode ser calculada analiticamente (manual) ou numericamente (regra do trap√©zio, Simpson, etc).<br>
                                    <em>Regra do Trap√©zio:</em> Aproxima a √°rea por pequenos trap√©zios sob a curva.
                                </p>
                                <p>
                                    <strong>Dicas:</strong><br>
                                    - Fun√ß√µes simples podem ser integradas manualmente.<br>
                                    - Para fun√ß√µes complexas, use m√©todos num√©ricos.<br>
                                    - O resultado pode ser negativo se a fun√ß√£o estiver abaixo do eixo $x$.<br>
                                    - A integral acumulada pode ser interpretada como soma cont√≠nua.
                                </p>
                                <p>
                                    <strong>Exemplo pr√°tico:</strong><br>
                                    Se $f(x) = x$, ent√£o $$ \\int_0^1 x \\, dx = 0.5 $$.<br>
                                    Para $f(x) = \\sin(x)+1$, a integral soma a √°rea acima do eixo $x$.<br>
                                    Se $f(x) = $ velocidade, a integral fornece a dist√¢ncia total percorrida.
                                </p>
                                <p>
                                    <strong>Curiosidade:</strong><br>
                                    O s√≠mbolo $\\int$ foi criado por Leibniz e representa a soma cont√≠nua de infinitos peda√ßos.
                                </p>
                            </div>
                        `;
                        break;
                    default:
                        html = `<div class="bg-white/50 dark:bg-black/20 rounded-lg p-3">
                                    <h4 class="font-semibold mb-2">üí° Bem-vindo!</h4>
                                    <p class="text-slate-600 dark:text-slate-300">Selecione uma opera√ß√£o no menu superior para come√ßar.</p>
                                </div>`;
                }
                this.ui.theoryContent.innerHTML = html;
                // Renderiza f√≥rmulas matem√°ticas ap√≥s inserir o HTML
                renderMathInElement(this.ui.theoryContent, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ]
                });
            },

            // --- L√ìGICA PRINCIPAL DE C√ÅLCULO E RENDERIZA√á√ÉO ---

            async handleCalculation() {
                if (!this.state.currentOperation || !this.validateFunction()) return;

                this.ui.calculateBtn.disabled = true;
                try {
                    const funcStr = this.helpers.parseFunction(this.ui.functionInput.value);
                    let resultData = {};
                    switch (this.state.currentOperation) {
                        case 'derivative': resultData = this.calculators.derivative(funcStr); break;
                        case 'critical': resultData = this.calculators.critical(funcStr); break;
                        case 'integral': resultData = this.calculators.integral(funcStr); break;
                    }
                    this.renderResults(resultData);
                } catch (error) {
                    console.error("Erro de c√°lculo:", error);
                } finally {
                    this.ui.calculateBtn.disabled = false;
                }
            },
            
            renderResults({ summaryHTML, stepsHTML, plotData, title }) {
                this.ui.summaryResults.innerHTML = summaryHTML;
                this.ui.stepByStepResults.innerHTML = stepsHTML || '';
                
                if (stepsHTML) {
                    renderMathInElement(this.ui.stepByStepResults, {
                        delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]
                    });
                }

                this.ui.resultsSection.classList.remove('hidden');
                window.scrollTo({ top: this.ui.resultsSection.offsetTop, behavior: 'smooth' });

                this.renderPlot(plotData, title);
            },
            
            renderPlot(plotData, title) {
                const layout = { ...this.config.plotLayout, title: { text: title, font: { size: 16 } } };
                Plotly.newPlot(this.ui.plotDiv, plotData, layout, { responsive: true, displaylogo: false });
                this.updatePlotTheme();
            },
            
            updatePlotTheme() {
                if(!this.ui.plotDiv.data) return;
                const bg = this.state.isDarkMode ? '#1e293b' : '#ffffff';
                const text = this.state.isDarkMode ? '#e2e8f0' : '#334155';
                const grid = this.state.isDarkMode ? '#334155' : '#e2e8f0';
                
                Plotly.relayout(this.ui.plotDiv, {
                    'paper_bgcolor': bg, 'plot_bgcolor': bg, 'font.color': text,
                    'xaxis.gridcolor': grid, 'yaxis.gridcolor': grid,
                });
            },

            // --- M√âTODOS AUXILIARES E DE C√ÅLCULO ---
            helpers: {
                parseFunction(funcStr) {
                    // Corrige multiplica√ß√µes impl√≠citas e fun√ß√µes matem√°ticas
                    return funcStr
                        .replace(/\s+/g, '')
                        // Adiciona * apenas entre n√∫mero e vari√°vel ou n√∫mero e par√™nteses
                        .replace(/(\d)([a-z])/gi, '$1*$2') // 2x -> 2*x
                        .replace(/(\d)\(/g, '$1*(')        // 2(x) -> 2*(x)
                        .replace(/([a-z])(\d)/gi, '$1*$2') // x2 -> x*2
                        .replace(/\)\(/g, ')*(')           // )( -> )*(
                        // N√£o adiciona * entre fun√ß√£o e par√™nteses
                        .replace(/ln/g, 'log')             // ln(x) -> log(x)
                        .replace(/e\^/g, 'exp');           // e^x -> expx
                },
                evaluateFunction(node, x) {
                    try {
                        const result = node.evaluate({ x });
                        return isFinite(result) ? result : NaN;
                    } catch { return NaN; }
                }
            },
            
            calculators: {
                derivative(funcStr) {
                    const x_point = parseFloat(document.getElementById('derivativePoint').value);
                    if (isNaN(x_point)) throw new Error('Ponto "x" inv√°lido.');
                    
                    const node = math.parse(funcStr);
                    const h = 0.0001;
                    const v = {
                        xp: x_point + h, xm: x_point - h,
                        fx: CalcProApp.helpers.evaluateFunction(node, x_point),
                        fxp: CalcProApp.helpers.evaluateFunction(node, x_point + h),
                        fxm: CalcProApp.helpers.evaluateFunction(node, x_point - h),
                    };
                    const d1 = (v.fxp - v.fxm) / (2 * h);
                    const d2 = (v.fxp - 2 * v.fx + v.fxm) / (h * h);
                    const d1Display = isNaN(d1) ? "Indefinido" : d1.toFixed(5);
                    const d2Display = isNaN(d2) ? "Indefinido" : d2.toFixed(5);

                    const summaryHTML = `
                        <div class="p-4 rounded-lg bg-white/50 dark:bg-black/20 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><p class="text-sm">Primeira Derivada em x = ${x_point}</p><p class="text-2xl font-bold text-blue-600 dark:text-blue-400">f'(${x_point}) ‚âà ${d1Display}</p></div>
                            <div><p class="text-sm">Segunda Derivada em x = ${x_point}</p><p class="text-2xl font-bold text-purple-600 dark:text-purple-400">f''(${x_point}) ‚âà ${d2Display}</p></div>
                        </div>`;

                    const stepsHTML = `<div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-lg mb-2">C√°lculo da Primeira Derivada (f')</h4>
                            <div class="space-y-3">
                                <div class="step-card p-4 rounded-lg"><p><strong>1. M√©todo:</strong> F√≥rmula das Diferen√ßas Centrais.</p><p class="text-center mt-2">$$ f'(x) \\approx \\frac{f(x + h) - f(x - h)}{2h} $$</p></div>
                                <div class="step-card p-4 rounded-lg"><p><strong>2. Par√¢metros:</strong> $x = ${x_point}$ e $h = ${h}$</p></div>
                                <div class="step-card p-4 rounded-lg"><p><strong>3. C√°lculo dos pontos:</strong></p><ul class="list-disc list-inside ml-4 font-mono"><li>$f(x+h) = f(${v.xp.toFixed(4)}) = ${v.fxp.toFixed(7)}$</li><li>$f(x-h) = f(${v.xm.toFixed(4)}) = ${v.fxm.toFixed(7)}$</li></ul></div>
                                <div class="step-card p-4 rounded-lg"><p><strong>4. Substitui√ß√£o:</strong></p><p class="text-center mt-2">$$ f'(${x_point}) \\approx \\frac{${v.fxp.toFixed(7)} - (${v.fxm.toFixed(7)})}{2 \\cdot ${h}} $$</p></div>
                                <div class="step-card p-4 rounded-lg bg-blue-100 dark:bg-blue-900/30 border-blue-500"><p><strong>5. Resultado:</strong></p><p class="text-center font-bold text-xl mt-1">$$ f'(${x_point}) \\approx ${d1Display} $$</p></div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-lg mb-2">C√°lculo da Segunda Derivada (f'')</h4>
                            <div class="space-y-3">
                                <div class="step-card p-4 rounded-lg"><p><strong>1. M√©todo:</strong> F√≥rmula das Diferen√ßas Centrais.</p><p class="text-center mt-2">$$ f''(x) \\approx \\frac{f(x + h) - 2f(x) + f(x - h)}{h^2} $$</p></div>
                                <div class="step-card p-4 rounded-lg"><p><strong>2. Ponto Central:</strong> $f(x) = f(${x_point}) = ${v.fx.toFixed(7)}$</p></div>
                                <div class="step-card p-4 rounded-lg"><p><strong>3. Substitui√ß√£o:</strong></p><p class="text-center mt-2">$$ f''(${x_point}) \\approx \\frac{${v.fxp.toFixed(7)} - 2(${v.fx.toFixed(7)}) + ${v.fxm.toFixed(7)}}{{${h}}^2} $$</p></div>
                                <div class="step-card p-4 rounded-lg bg-purple-100 dark:bg-purple-900/30 border-purple-500"><p><strong>4. Resultado:</strong></p><p class="text-center font-bold text-xl mt-1">$$ f''(${x_point}) \\approx ${d2Display} $$</p></div>
                            </div>
                        </div>
                    </div>`;
                    
                    const plotData = [], xValues = [];
                    const nodeD1 = math.derivative(funcStr, 'x'), nodeD2 = math.derivative(nodeD1, 'x');
                    for (let x = x_point - 5; x <= x_point + 5; x += 0.1) xValues.push(x);
                    
                    const traces = [
                        { name: 'f(x)', node: node, color: '#3b82f6', width: 3 },
                        { name: "f'(x)", node: nodeD1, color: '#ef4444', dash: 'dash' },
                        { name: "f''(x)", node: nodeD2, color: '#22c55e', dash: 'dot' },
                    ];

                    traces.forEach(trace => {
                        const yValues = xValues.map(x => CalcProApp.helpers.evaluateFunction(trace.node, x));
                        plotData.push({ x: xValues, y: yValues, name: trace.name, type: 'scatter', mode: 'lines', line: { color: trace.color, width: trace.width, dash: trace.dash } });
                    });
                    
                    return { summaryHTML, stepsHTML, plotData, title: `An√°lise da Derivada de f(x)` };
                },
                critical(funcStr) {
                    // Obt√©m os limites do intervalo
                    const a = parseFloat(document.getElementById('lowerLimit').value);
                    const b = parseFloat(document.getElementById('upperLimit').value);
                    if (isNaN(a) || isNaN(b) || a >= b) {
                        return { summaryHTML: '<p>Intervalo inv√°lido.</p>', plotData: [], title: '' };
                    }

                    // Derivadas
                    const node = math.parse(funcStr);
                    const d1 = math.derivative(funcStr, 'x');
                    const d2 = math.derivative(d1, 'x');

                    // Busca zeros da primeira derivada (pontos cr√≠ticos)
                    const step = (b - a) / 200;
                    let criticalPoints = [];
                    for (let x = a; x < b; x += step) {
                        const y1 = CalcProApp.helpers.evaluateFunction(d1, x);
                        const y2 = CalcProApp.helpers.evaluateFunction(d1, x + step);
                        if (isFinite(y1) && isFinite(y2) && y1 * y2 < 0) {
                            // Aproxima√ß√£o do zero entre x e x+step
                            const xc = (x + x + step) / 2;
                            criticalPoints.push(xc);
                        }
                    }

                    // Classifica os pontos cr√≠ticos usando a segunda derivada
                    let summaryHTML = '<h4 class="font-bold mb-2">Pontos Cr√≠ticos Encontrados:</h4><ul class="list-disc ml-6">';
                    if (criticalPoints.length === 0) {
                        summaryHTML += '<li>Nenhum ponto cr√≠tico encontrado no intervalo.</li>';
                    } else {
                        criticalPoints.forEach(xc => {
                            const fx = CalcProApp.helpers.evaluateFunction(node, xc);
                            const d2val = CalcProApp.helpers.evaluateFunction(d2, xc);
                            let tipo = '';
                            if (d2val > 0) tipo = 'M√≠nimo Local';
                            else if (d2val < 0) tipo = 'M√°ximo Local';
                            else tipo = 'Ponto de inflex√£o ou indefinido';
                            summaryHTML += `<li>x = ${xc.toFixed(4)}, f(x) = ${fx.toFixed(4)} <span class="font-semibold">(${tipo})</span></li>`;
                        });
                    }
                    summaryHTML += '</ul>';

                    // Passo a passo
                    let stepsHTML = `
                        <div class="step-card p-4 rounded-lg mb-3">
                            <strong>1. Derivada:</strong> Calculamos f'(x) e f''(x) simbolicamente.<br>
                            <span class="font-mono">f'(x) = ${d1.toString()}</span><br>
                            <span class="font-mono">f''(x) = ${d2.toString()}</span>
                        </div>
                        <div class="step-card p-4 rounded-lg mb-3">
                            <strong>2. Busca num√©rica:</strong> Procuramos onde f'(x) muda de sinal no intervalo [${a}, ${b}].
                        </div>
                        <div class="step-card p-4 rounded-lg mb-3">
                            <strong>3. Classifica√ß√£o:</strong> Para cada ponto cr√≠tico, verificamos f''(x) para classificar como m√≠nimo, m√°ximo ou inflex√£o.
                        </div>
                    `;

                    // Gr√°fico
                    const xValues = [];
                    for (let x = a; x <= b; x += step) xValues.push(x);
                    const yValues = xValues.map(x => CalcProApp.helpers.evaluateFunction(node, x));
                    const plotData = [
                        { x: xValues, y: yValues, name: 'f(x)', type: 'scatter', mode: 'lines', line: { color: '#3b82f6', width: 3 } },
                        {
                            x: criticalPoints, y: criticalPoints.map(xc => CalcProApp.helpers.evaluateFunction(node, xc)),
                            name: 'Pontos Cr√≠ticos', type: 'scatter', mode: 'markers',
                            marker: { color: '#ef4444', size: 12, symbol: 'diamond' }
                        }
                    ];

                    return { summaryHTML, stepsHTML, plotData, title: 'An√°lise de Pontos Cr√≠ticos' };
                },
                integral(funcStr) {
                    // Obt√©m os limites do intervalo
                    const a = parseFloat(document.getElementById('lowerLimit').value);
                    const b = parseFloat(document.getElementById('upperLimit').value);
                    if (isNaN(a) || isNaN(b) || a >= b) {
                        return { summaryHTML: '<p>Intervalo inv√°lido.</p>', plotData: [], title: '' };
                    }

                    // Parse da fun√ß√£o
                    const node = math.parse(funcStr);

                    // C√°lculo num√©rico da integral (regra do trap√©zio)
                    const n = 200;
                    const h = (b - a) / n;
                    let integral = 0;
                    const xValues = [];
                    const yValues = [];
                    for (let i = 0; i <= n; i++) {
                        const x = a + i * h;
                        const y = CalcProApp.helpers.evaluateFunction(node, x);
                        xValues.push(x);
                        yValues.push(y);
                        if (i === 0 || i === n) {
                            integral += y / 2;
                        } else {
                            integral += y;
                        }
                    }
                    integral *= h;

                    // HTML de resumo
                    const summaryHTML = `
                        <div class="p-4 rounded-lg bg-white/50 dark:bg-black/20">
                            <p class="text-sm">Integral definida de <strong>a = ${a}</strong> at√© <strong>b = ${b}</strong>:</p>
                            <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">$$ \\int_{${a}}^{${b}} f(x) dx \\approx ${integral.toFixed(6)} $$</p>
                        </div>
                    `;

                    // Passo a passo
                    const stepsHTML = `
                        <div class="step-card p-4 rounded-lg mb-3">
                            <strong>1. M√©todo:</strong> Regra do Trap√©zio com ${n} subintervalos.<br>
                            <span class="font-mono">h = ${(h).toFixed(4)}</span>
                        </div>
                        <div class="step-card p-4 rounded-lg mb-3">
                            <strong>2. C√°lculo:</strong> Somamos as √°reas dos trap√©zios entre a e b.
                        </div>
                        <div class="step-card p-4 rounded-lg mb-3">
                            <strong>3. Resultado:</strong> $$ \\int_{${a}}^{${b}} f(x) dx \\approx ${integral.toFixed(6)} $$
                        </div>
                    `;

                    // Gr√°fico
                    const plotData = [
                        { x: xValues, y: yValues, name: 'f(x)', type: 'scatter', mode: 'lines', line: { color: '#8b5cf6', width: 3 } }
                    ];

                    return { summaryHTML, stepsHTML, plotData, title: 'Integral Definida' };
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => CalcProApp.init());
    </script>
</body>
</html>
